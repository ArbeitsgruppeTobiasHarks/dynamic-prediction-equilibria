\documentclass[12pt]{article}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{tikz}


\begin{document}

\title{Trying to converge to an equilibrium flow}
\maketitle

Throughout, Vickrey queuing model is used.

\section*{Iterative Model}

TBD

$$ h_P^{(i+1)}(\theta) = \left(1 - \alpha( d_P^{(i)}(\theta)) \right) \cdot h_P^{i}(\theta) + \frac{ \mathbb{I}_{ \{d_P^{(i)} < \varepsilon \}} (\theta) }{\sum_{P'} \mathbb{I}_{ \{d_{P'}^{(i)} < \varepsilon \}} (\theta)} \cdot \left( \sum_{P'} \alpha( d_P^{(i)}(\theta)) \cdot h_P^{i}(\theta) \right).$$

%\sum_{} \mathbb{I}_{d_P^{i}(\theta) < \varepsilon}

\section*{Dynamic Replicator Model}

Let $\mathcal{P}$ be a collection of $s$-$t$ paths. At time $\theta$, each path $P$ receives a fraction $h_P(\theta)$ of the total inflow $u(\theta)$. We are considering the replication dynamic: 

$$ \dot{h}_P = R \cdot h_P \cdot a_P, \quad ~\forall P \in \mathcal{P}, $$
where $R > 0$ is a constant, $a_P = \phi_P - \sum_{P' \in \mathcal{P}} h_{P'} \cdot \phi_{P'}$ is advantage function based on fitness $\phi$. 

 Role of the fitness can be played by negative signed average experienced travel time of the particles:
%($\theta_l = \max( \theta - w, 0 )$)
$$ \phi^{a.t.}_P(\theta, h) = - \frac{1} {F_P^+(\theta)} \left( \int_{0}^{\theta} F_P^+(\psi) d \psi - \int_{0}^{\theta} F_P^{-} (\psi) d \psi \right) .$$
Above, $F_P^+(\cdot)$, $F_P^-(\cdot)$ denote functions of accumulated path in- and outflow.

Another option is  negative signed last available travel time:
$$ \phi^{l.t.}_P(\theta, h) = -1 \cdot \begin{cases} \theta, & 0 \leq \theta < T_P(0) \\ \theta - T_P^{-1}(\theta), & \theta \geq T_P(0) \end{cases} ,$$
 $T_P(\cdot)$ is path exit time function.
 
Finally, utilising constant predictors for queues, one can predict path exit times $ \hat{T}_P $ and use negative predicted travel time:
$$ \phi^{p.t.}_P(\theta, h) = - (\hat{T}_P(\theta) - \theta) .$$
If path $P$ has only one edge, then $ \hat{T}_P(\cdot) \equiv T_P(\cdot) $.

\subsection*{Considered Instance}

Consider simple network with two parallel edges on Figure \ref{fig:instance}. Let upper edge have index $0$ and lower $1$. We consider inflow $u(\theta) \equiv U$.

\begin{figure}
	\begin{center}
		\begin{tikzpicture}[scale=0.2]
			\tikzstyle{every node}+=[inner sep=0pt]
			\draw [black] (7.2,-8.7) circle (3);
			\draw (7.2,-8.7) node {$s$};
			\draw [black] (27.1,-8.7) circle (3);
			\draw (27.1,-8.7) node {$t$};
			\draw [black] (9.808,-7.224) arc (114.62656:65.37344:17.62);
			\fill [black] (24.49,-7.22) -- (23.97,-6.44) -- (23.56,-7.35);
			\draw (17.15,-5.12) node [above] {$\tau=1, \nu=2$};
			\draw [black] (24.706,-10.5) arc (-58.92949:-121.07051:14.642);
			\fill [black] (24.71,-10.5) -- (23.76,-10.48) -- (24.28,-11.34);
			\draw (17.15,-13.1) node [below] {$\tau=2, \nu=3$};
		\end{tikzpicture}
	\end{center}
	\caption{Simple network}
	\label{fig:instance}
\end{figure}

The equilibrium flow is achieved as follows: all the inflow is redirected to the shorter edge, until both edges achieve equal costs, then the distribution is proportional to the capacities.
$$ h^*_0(\theta) = \begin{cases} 1, & 0 \leq \theta < \frac{2}{3} \\ \frac{2}{5}, &\theta \geq \frac{2}{3} \end{cases}, \quad h^*_1(\theta) = 1 - h^*_0(\theta) .$$


\subsection*{Numerical Approximation}

 show numerically computed inflow shares and fitness of replicator flow with initial condition $h_0(0) = h_1(0) = \frac{1}{2}$. The following approximation was used:

$$ h_P(\theta + \Delta\theta) \approx \frac{ h_P(\theta) \cdot e^{ R \cdot a_P \cdot \Delta \theta }} { \sum_{P'}  h_{P'}(\theta) \cdot e^{ R \cdot a_{P'} \cdot \Delta\theta } } .$$

By construction of the initial dynamic $\sum_{P'}  h_{P'}(\theta) \cdot e^{ R \cdot a_{P'} \cdot \Delta\theta } = 1 + o(\Delta \theta)$. Normalisation is required to remain on simplex.

\newpage

\subsection*{Stabilizing Dynamics (max demand)}

\subsubsection*{Logit Regularization}

One can use modify the fitness using logit regularizer:
$$ \phi^{\text{reg}}_P(\theta, h) = \phi_P(\theta, h) - \lambda e^{-\gamma \cdot \theta} \ln{ h_P(\theta) }, $$
where $\lambda > 0$ is a scaling constant, $\gamma > 0$ is regularization decay. Figure \ref{fig:reg_pred_tt} shows

\begin{figure}
	\includegraphics[width=0.9\textwidth]{img/reg_pred_tt.eps}
	\caption{Predicted travel time with logit regularization $\lambda=1$}
	\label{fig:reg_pred_tt}

\end{figure}

\subsubsection*{Projected Travel Times}

If we use projected queue values $\hat{q}^{\delta}_e(\theta') = q_e(\theta) + \frac{q_e(\theta) - q_e(\theta - \delta)}{\delta} \cdot (\theta' - \theta)$ to estimate upcoming travel times, we can use fitness $$ \phi^{\text{proj t.t.}}(\theta, h) = -(t_P(\theta) + w \cdot \frac{\partial t_P}{\partial \theta}(\theta)) \approx - ( \tau_P + \frac{1}{\nu_P} \hat{q}^{\delta}_e(\theta + w) ). $$  Projection window $w$ is a paramater. 

\subsubsection*{Analysis}

We denote $\Phi(\theta) := t_0(\theta) - t_1(\theta)$, 

 $$ , \quad \dot{\Phi} = \left(\frac{U h_0}{\nu_0} - 1 \right) \mathbb{I}_{[q_0 > 0]} - \left(\frac{U (1 - h_0)}{\nu_1} - 1 \right)\mathbb{I}_{[q_1 > 0]} . $$
 
 $$ \phi_0(\theta) - \phi_1(\theta) = \Phi(\theta) + w \cdot \dot{\Phi} (\theta)$$
 
 \begin{itemize}
 
	\item $ q_0 > 0, q_1 > 0 $
		
	$$ h_0 = \frac{\dot{\Phi} + \frac{U}{\nu_1}}{\frac{U}{\nu_0} + \frac{U}{\nu_1}} \to \frac{\nu_0}{\nu_0 + \nu_1 },\quad 1 - h_0 = \frac{\frac{U}{\nu_0} - \dot{\Phi}}{{\frac{U}{\nu_0} + \frac{U}{\nu_1}}} . $$

$$ \frac{\ddot{\Phi}}{\frac{U}{\nu_0} + \frac{U}{\nu_1}} = -R \frac{\dot{\Phi} + \frac{U}{\nu_1}}{\frac{U}{\nu_0} + \frac{U}{\nu_1}} \cdot \frac{\frac{U}{\nu_0} - \dot{\Phi}}{\frac{U}{\nu_0} + \frac{U}{\nu_1}} \cdot (\Phi + w \dot{\Phi}) $$

$$ \ddot{\Phi} \approx - k (\Phi + w \dot{\Phi}), \quad k = R \frac{U}{\nu_0 + \nu_1} $$

 
	
	\item $ q_0 > 0, q_1 = 0 $ 
	
		$$ h_0 = \frac{\dot{\Phi} + 1}{\frac{U}{\nu_0}} ,\quad 1 - h_0 = \frac{\frac{U}{\nu_0} - 1 - \dot{\Phi}}{{\frac{U}{\nu_0} }} . $$

$$ \frac{\ddot{\Phi}}{\frac{U}{\nu_0} } = -R \frac{\dot{\Phi} + 1}{\frac{U}{\nu_0} } \cdot \frac{\frac{U}{\nu_0} - 1 - \dot{\Phi}}{{\frac{U}{\nu_0} }} \cdot (\Phi + w \dot{\Phi}) $$

$$ \ddot{\Phi} \approx - k (\Phi + w \dot{\Phi}), \quad k = R( 1 -\frac{\nu_0}{U}) $$

	\item $ q_0 = 0, q_1 > 0 $ 
	
		$$ h_0 = \frac{\dot{\Phi} + \frac{U}{\nu_1} - 1}{\frac{U}{\nu_1}} ,\quad 1 - h_0 = \frac{ 1 - \dot{\Phi}}{{\frac{U}{\nu_1} }} . $$

$$ \frac{\ddot{\Phi}}{\frac{U}{\nu_1} } = -R \frac{\dot{\Phi} + \frac{U}{\nu_1} - 1}{\frac{U}{\nu_1}} \cdot \frac{ 1 - \dot{\Phi}}{{\frac{U}{\nu_1} }} \cdot (\Phi + w \dot{\Phi}) $$

$$ \ddot{\Phi} \approx - k (\Phi + w \dot{\Phi}), \quad k = R( 1 -\frac{\nu_1}{U}) $$

 
 \end{itemize}

\subsubsection*{Max demand}

$U = \nu_0 + \nu_1$

See Figure \ref{fig:fluctuations_proj}. Figures \ref{fig:amplitudes_proj} and \ref{fig:final_tt_proj} show inflow amplitude decays and final travel times for different projection windows.

\begin{figure}
	\includegraphics[width=0.9\textwidth]{img/replicator_proj_tt.eps}
	\caption{ $ \phi = -\hat{t}^{2\Delta \theta}(\theta + w), R=0.1, \Delta \theta = 0.01$}
	\label{fig:fluctuations_proj}

\end{figure}
	
\begin{figure}
	\includegraphics[width=0.9\textwidth]{img/amplitudes_proj_tt.eps}
	\caption{ Inflow amplitudes for path 0 }
	\label{fig:amplitudes_proj}

\end{figure}

\begin{figure}
	\includegraphics[width=0.9\textwidth]{img/final_tt_proj.eps}
	\caption{ Final travel times }
	\label{fig:final_tt_proj}

\end{figure}

\begin{figure}
	\includegraphics[width=0.9\textwidth]{img/replicator_grad_tt.eps}
	\caption{ Travel time gradient as fitness }
	\label{fig:replicator_grad_tt}

\end{figure}

\newpage
\subsubsection*{Medium Demand}

$ \nu_0 < U < \nu_0 + \nu_1$

Figure \ref{fig:replicator_medium_demand} shows dynamics for the faster edge 0 with different projection windows. 
Both fitnesses eventually stabilize to values $\phi = -\tau_1$ (negative cost of slower edge).
It also appears that the queue doesn't form on edge 1, so it has constant fitness $\phi_1(\theta) \equiv - \tau_1 $.

\begin{figure}
	\includegraphics[width=0.9\textwidth]{img/replicator_medium_demand.eps}
	\caption{ Medium demand }
	\label{fig:replicator_medium_demand}

\end{figure}

Now assume that edge 0 operates on full capacity and  edge 1 always operates below capacity, i.e.

$$q_0(\theta) = \int_0^\theta (U\cdot h_0(z) - \nu_0) dz, \quad
 q_1(\theta) \equiv 0 .$$

This  allows to write the replication equation
$$ \dot{h}_0 = R \cdot h_0 \cdot (\phi_0 - h_0\phi_0 - (1-h_0)\phi_1) = -R \cdot h_0 \cdot ( 1- h_0 ) \cdot \left( \tau_0 + \frac{1}{\nu_0} (q_0 + w \cdot \frac{\partial q_0}{\partial \theta}) - \tau_1 \right) $$
in the form
$$ \ddot{\Phi} = - R \cdot (\Phi + w \dot{\Phi}) \cdot  (1+ \dot{\Phi}) \cdot (1 -  h^* (1+ \dot{\Phi})),$$
 where the following notation is used: 
 $$h^* := \frac{\nu_0}{U}, \quad \Phi(\theta) := t_0(\theta) - t_1(\theta) = \int_0^{\theta} \frac{h_0(z) - h^*}{h^*} dz + \tau_0  - \tau_1 .$$
  We have $ h_0(\theta) = h^* (1 + \dot{\Phi}(\theta))$ and the assumptions can be written as 
 $$\Phi(\theta) - \Phi(0) \geq 0; \quad \dot{\Phi}(\theta) \geq \frac{U - \nu_1 - \nu_0}{\nu_0} .$$

If we further assume that $\dot{\Phi}$ is small (i.e. $h_0$ is close to $h^*$), we can make a simplification and analyze the linear equation
$$ \ddot{F} = - R \cdot(F + w \dot{F}) \cdot (1-h^*) \quad \Leftrightarrow \quad \ddot{F} + kw\dot{F} + kF = 0 , \quad k = R(1-h^*).$$

This yields a theoretical estimate of decay rate:
$$ w \leq \frac{2}{\sqrt{k}}: \quad h_0 - h^* \propto e^{-\frac{kw}{2} \theta}$$ 
$$w > \frac{2}{\sqrt{k}}: \quad h_0 - h^* \propto e^{-\frac{kw - \sqrt{(kw)^2 - 4k}}{2}\theta}$$

Figure \ref{fig:amplitudes_decay} shows that the estimate is good in case $w > \frac{2}{\sqrt{k}}$.

\begin{figure}
	\includegraphics[scale=0.5]{img/amplitudes_decay.eps}
	\caption{Amplitudes decay }
	\label{fig:amplitudes_decay}

\end{figure}	

Figure \ref{fig:de_comparison} shows the difference between theoretical and observed dynamics. Used parameters: $ U = 4.5; \Delta\theta = 0.01;  h_0(0) = 0.5;  R = 0.1; w = 1.0 $

\begin{figure}
	\includegraphics[scale=0.75]{img/de_comparison.eps}
	\caption{Solution of DEs compared to the experiment; gray dashed lines show illustrate fulfillment of assumptions }
	\label{fig:de_comparison}

\end{figure}	


\newpage
\subsection*{Unstable dynamics}

Figures \ref{fig:fluctuations_avg}, \ref{fig:fluctuations_last} and \ref{fig:fluctuations_pred} show how using bad fitness leads to divergence.

\begin{center}
	\begin{figure}
	\includegraphics[scale=0.5]{img/replicator_avg_tt.eps}
	\caption{Fluctuations, average travel time }
	\label{fig:fluctuations_avg}

	\end{figure}
	
\end{center}

\begin{center}
	\begin{figure}
	\includegraphics[scale=0.5]{img/replicator_last_tt.eps}
	\caption{Fluctuations, last travel time }
	\label{fig:fluctuations_last}

	\end{figure}
	
\end{center}

\begin{center}
	\begin{figure}
	\includegraphics[scale=0.5]{img/replicator_pred_tt.eps}
	\caption{Fluctuations, predicted travel time }
	\label{fig:fluctuations_pred}

	\end{figure}
	
\end{center}

\subsubsection*{Proof ?}

Necessary condition for stability: $ \forall P: ~ \phi_P(\theta, h) = \sum_{P'} h_{P'}(\theta) \phi_{P'}(\theta, h) $. \\
In cases of average travel time and last travel, influence of inflows on fitnesses is delayed for at least $\tau_0$. \\ 

Sufficient condition for stability for non-aggregated travel times: queues have to not change for the period of delay. This guarantees that fitnesses don't change once equality is reached.
\\

Even when we use undelayed travel times, inflows tend to get in antiphase with fitnesses.
In this example, we need inflows to equalize with edge capacities at the moment when both path have same costs.


\end{document}